(ns camunda-external-task-client-clojure.core
  (:import [org.camunda.bpm.client ExternalTaskClient]))

(defn set-up [url]
  (.build (.baseUrl (ExternalTaskClient/create) url)))

(defn handle! [handler-func]
  (reify org.camunda.bpm.client.task.ExternalTaskHandler
    (execute [this external-task external-task-service]
      (.complete external-task-service external-task (handler-func)))))

(defn subscribe [url topic logger]
  (let [client (set-up url)]
    (.info logger "Subscribing")
    (.open (.handler (.lockDuration (.subscribe client
                                                topic)
                                    1000)
                     (handle! #({:val 1}))))))

(defn debug [] (subscribe "http://localhost:8080/engine-rest"
            "provide_input"
            (org.slf4j.LoggerFactory/getLogger "logger")))
